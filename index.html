<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="style.css">

    <title>Mini Project</title>
    
    <!-- Updated Visitor Analytics Tracking Script -->
    <script>
    (function() {
        // Server URL - replace with your actual server address
        const SERVER_URL = 'http://localhost:3000';
        
        // Function to check if localStorage is available
        function isLocalStorageAvailable() {
            try {
                const testKey = 'test';
                localStorage.setItem(testKey, testKey);
                localStorage.removeItem(testKey);
                return true;
            } catch (error) {
                return false;
            }
        }
        
        // Function to generate a visitor ID
        function generateVisitorId() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }
        
        // Function to check if it's a mobile device
        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }
        
        // Function to handle cookies
        function getCookie(name) {
            const nameEQ = name + "=";
            const ca = document.cookie.split(';');
            for(let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) === ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
            }
            return null;
        }
        
        function setCookie(name, value, days) {
            const d = new Date();
            d.setTime(d.getTime() + (days*24*60*60*1000));
            document.cookie = name + "=" + value + ";expires=" + d.toUTCString() + ";path=/;SameSite=Lax";
        }
        
        // Wait for page to load
        window.addEventListener('load', function() {
            try {
                // Check if localStorage is available
                const localStorageAvailable = isLocalStorageAvailable();
                
                // Get or create visitor ID
                let visitorId;
                if (localStorageAvailable) {
                    visitorId = localStorage.getItem('visitor_id');
                    if (!visitorId) {
                        visitorId = generateVisitorId();
                        localStorage.setItem('visitor_id', visitorId);
                    }
                } else {
                    // Fallback to cookie
                    visitorId = getCookie('visitor_id');
                    if (!visitorId) {
                        visitorId = generateVisitorId();
                        setCookie('visitor_id', visitorId, 30);
                    }
                }
                
                // Create visit data object
                const visitData = {
                    visitor_id: visitorId,
                    timestamp: new Date().toISOString(),
                    url: window.location.href,
                    path: window.location.pathname,
                    referrer: document.referrer || "direct",
                    user_agent: navigator.userAgent,
                    screen_width: screen.width,
                    screen_height: screen.height
                };
                
                // Choose tracking method based on device
                if (isMobileDevice()) {
                    console.log("Using image pixel tracking for mobile device");
                    const imgTracker = new Image();
                    imgTracker.onload = function() { 
                        console.log("Mobile tracking image loaded successfully"); 
                    };
                    imgTracker.onerror = function() { 
                        console.error("Mobile tracking image failed to load");
                        saveFallbackData(visitData, localStorageAvailable);
                    };
                    imgTracker.src = `${SERVER_URL}/api/track-pixel?data=${encodeURIComponent(JSON.stringify(visitData))}`;
                } else {
                    // Desktop tracking using fetch
                    fetch(`${SERVER_URL}/api/track`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(visitData),
                        mode: 'cors',
                        credentials: 'omit'
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok: ' + response.status);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log("Visit recorded on server:", data);
                    })
                    .catch(error => {
                        console.error("Error sending data to server:", error.name, error.message);
                        saveFallbackData(visitData, localStorageAvailable);
                    });
                }
                
                // Function to save data locally if server is unavailable
                function saveFallbackData(data, useLocalStorage) {
                    console.log("Using fallback storage method");
                    if (useLocalStorage) {
                        let allVisits = JSON.parse(localStorage.getItem('site_visits') || '[]');
                        allVisits.push(data);
                        localStorage.setItem('site_visits', JSON.stringify(allVisits));
                        console.log("Data saved to localStorage");
                    } else {
                        try {
                            let allVisits = JSON.parse(getCookie('site_visits') || '[]');
                            allVisits.push(data);
                            setCookie('site_visits', JSON.stringify(allVisits), 7);
                            console.log("Data saved to cookie");
                        } catch (e) {
                            console.error("Failed to save to cookie:", e);
                        }
                    }
                }
                
            } catch (error) {
                console.error("Error tracking visit:", error);
            }
        });
    })();
    </script>
  </head>
  <body style="background-image: url('bg_img.png');" onload="myFunction()">
      <ul class="topnav">
        <li><a class="active" href="#home">Home</a></li>
        <li><a href="rating.html">Ratings</a></li>
        <li><a href="resume.html">Create Resume</a></li>
    </ul>
    
    <section class="column">
      <a href="masud.html">
        <img src="KMC.png" width="500px" height="500px">
      </a>
      <div id="faraz">
        <a href="https://faraz6188.github.io/Portfolio/">
          <img src="MFA.png" width="500px" height="500px">
        </a>
      </div>
    </section>
    <h1 style="color: wheat;">A website with Simple resume generator, 5 Star Ratings & reviews and Views counter</h1>

    <button class="info" onclick="myFunction()">Show total Views</button>

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.3/dist/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
    <script type="text/JavaScript" src="javascript.js"></script>

    <footer style="color: wheat;">
      Copyright Â© 2023 | Mini Project of MGM's CEN | Powered by Mohammed Faraz Ali & Khalid Masud Chaudhary
    </footer>
  </body>
</html>
