<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="style.css">

    <title>Mini Project</title>
    
    <!-- Cross-Platform Analytics Tracking Script -->
   <script>
    const API_BASE_URL = "https://visitor-tracker-server.onrender.com";

    async function loadAnalytics() {
        try {
            const response = await fetch(`${API_BASE_URL}/api/analytics`);
            if (!response.ok) {
                throw new Error('Failed to fetch analytics data');
            }

            const data = await response.json();

            const uniqueVisitors = new Set(data.map(visit => visit.visitor_id)).size;
            const mobileVisits = data.filter(visit => isMobileUA(visit.user_agent)).length;
            const desktopVisits = data.length - mobileVisits;

            document.getElementById('total-visits').textContent = data.length;
            document.getElementById('unique-visitors').textContent = uniqueVisitors;
            document.getElementById('mobile-visits').textContent = mobileVisits;
            document.getElementById('desktop-visits').textContent = desktopVisits;

            const tableBody = document.getElementById('visits-data');
            tableBody.innerHTML = '';

            data.slice(0, 100).forEach(visit => {
                const row = document.createElement('tr');

                const deviceType = isMobileUA(visit.user_agent) ? 'Mobile' : 'Desktop';
                const deviceInfo = deviceType + getDeviceDetails(visit.user_agent);
                const date = new Date(visit.timestamp);
                const formattedDate = date.toLocaleString();

                row.innerHTML = `
                    <td>${visit.id}</td>
                    <td title="${visit.visitor_id}">${visit.visitor_id.substring(0, 8)}...</td>
                    <td>${formattedDate}</td>
                    <td title="${visit.url}">${formatUrl(visit.url)}</td>
                    <td>${visit.referrer || 'Direct'}</td>
                    <td>${deviceInfo}</td>
                    <td>${visit.screen_width}x${visit.screen_height}</td>
                    <td>${visit.ip_address}</td>
                `;

                tableBody.appendChild(row);
            });

        } catch (error) {
            console.error('Error loading analytics:', error);
            document.getElementById('visits-data').innerHTML =
                `<tr><td colspan="8" class="text-center text-danger">Error loading data: ${error.message}</td></tr>`;
        }
    }

    function isMobileUA(userAgent) {
        return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(userAgent);
    }

    function getDeviceDetails(userAgent) {
        let details = '';
        if (userAgent.includes('iPhone') || userAgent.includes('iPad')) {
            details = ' (iOS)';
        } else if (userAgent.includes('Android')) {
            details = ' (Android)';
        }

        if (userAgent.includes('Safari') && !userAgent.includes('Chrome')) {
            details += ' Safari';
        } else if (userAgent.includes('Chrome')) {
            details += ' Chrome';
        } else if (userAgent.includes('Firefox')) {
            details += ' Firefox';
        }

        return details;
    }

    function formatUrl(url) {
        if (!url) return 'Unknown';
        try {
            const urlObj = new URL(url);
            return urlObj.pathname.length > 1 ?
                urlObj.hostname + urlObj.pathname :
                urlObj.hostname;
        } catch (e) {
            return url.substring(0, 30) + '...';
        }
    }

    document.addEventListener('DOMContentLoaded', loadAnalytics);
    setInterval(loadAnalytics, 30000);
</script>

  </head>
  <body onload="myFunction()" style="background-image: url('bg_img.png');">
      <ul class="topnav">
        <li><a class="active" href="#home">Home</a></li>
        <li><a href="rating.html">Ratings</a></li>
        <li><a href="resume.html">Create Resume</a></li>
    </ul>
    
    <section class="column">
      <a href="masud.html">
        <img src="KMC.png" width="500px" height="500px">
      </a>
      <div id="faraz">
        <a href="https://faraz6188.github.io/Portfolio/">
          <img src="MFA.png" width="500px" height="500px">
        </a>
      </div>
    </section>
    <h1 style="color: wheat;">A website with Simple resume generator, 5 Star Ratings & reviews and Views counter</h1>

    <button class="info" onclick="myFunction()">Show total Views</button>

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.3/dist/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
    <script type="text/JavaScript" src="javascript.js"></script>

    <footer style="color: wheat;">
      Copyright Â© 2020 | Mini Project of MGM's CEN | Powered by Mohammed Faraz Ali & Khalid Masud Chaudhary
    </footer>
  </body>
</html>
