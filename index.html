<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="style.css">

    <title>Mini Project</title>
    
    <!-- Analytics Tracking Script -->
    <script>
      // Analytics Client Script
      (function() {
          // Generate a unique visitor ID or retrieve existing one
          function getVisitorId() {
              let visitorId = localStorage.getItem('visitor_tracker_id');
              if (!visitorId) {
                  visitorId = 'v' + Math.random().toString(36).substring(2, 15) + 
                              Math.random().toString(36).substring(2, 15);
                  localStorage.setItem('visitor_tracker_id', visitorId);
              }
              return visitorId;
          }

          // Track page visit with more reliable error handling
          function trackPageView() {
              try {
                  const visitorId = getVisitorId();
                  const timestamp = new Date().toISOString();
                  const currentUrl = window.location.href;
                  const path = window.location.pathname;
                  const referrer = document.referrer;
                  const userAgent = navigator.userAgent;
                  const screenWidth = window.screen.width;
                  const screenHeight = window.screen.height;
                  
                  const visitData = {
                      visitor_id: visitorId,
                      timestamp: timestamp,
                      url: currentUrl,
                      path: path,
                      referrer: referrer,
                      user_agent: userAgent,
                      screen_width: screenWidth,
                      screen_height: screenHeight,
                      event_type: 'page_view'
                  };

                  // Console log for debugging
                  console.log('Sending tracking data:', visitData);

                  // Always use the Render deployment URL for reliability
                  const trackingServerUrl = 'https://visitor-tracker-server.onrender.com';
                  console.log('Using tracking server base URL:', trackingServerUrl);

                  // Send tracking data to server with absolute URL
                  fetch(trackingServerUrl + '/api/track', {
                      method: 'POST',
                      headers: {
                          'Content-Type': 'application/json'
                      },
                      body: JSON.stringify(visitData),
                      mode: 'cors', // Enable CORS explicitly
                      cache: 'no-cache' // Prevent caching
                  })
                  .then(response => {
                      if (!response.ok) {
                          throw new Error('Failed to send tracking data: ' + response.status);
                      }
                      return response.json();
                  })
                  .then(data => {
                      console.log('Visit tracking successful', data);
                  })
                  .catch(error => {
                      console.error('Error sending tracking data:', error);
                      // Fallback to tracking pixel
                      sendTrackingPixel(visitData, trackingServerUrl);
                  });
              } catch (e) {
                  console.error('Error in tracking script:', e);
              }
          }

          // Fallback method using tracking pixel
          function sendTrackingPixel(visitData, baseUrl) {
              try {
                  console.log('Falling back to tracking pixel');
                  const encodedData = encodeURIComponent(JSON.stringify(visitData));
                  const img = new Image();
                  img.onload = () => console.log('Tracking pixel loaded');
                  img.onerror = (e) => console.error('Tracking pixel failed to load', e);
                  img.src = `${baseUrl}/api/track-pixel?data=${encodedData}&nocache=${new Date().getTime()}`;
                  document.body.appendChild(img);
                  img.style.display = 'none';
              } catch (e) {
                  console.error('Error sending tracking pixel:', e);
              }
          }

          // Set up exit tracking to measure duration
          let pageEnterTime = new Date();
          
          function trackExit() {
              try {
                  const duration = Math.floor((new Date() - pageEnterTime) / 1000);
                  const visitorId = getVisitorId();
                  
                  const exitData = {
                      visitor_id: visitorId,
                      timestamp: new Date().toISOString(),
                      url: window.location.href,
                      path: window.location.pathname,
                      event_type: 'page_exit',
                      duration: duration
                  };
                  
                  // Use sendBeacon for more reliable exit tracking
                  if (navigator.sendBeacon) {
                      const trackingServerUrl = 'https://visitor-tracker-server.onrender.com';
                      navigator.sendBeacon(
                          trackingServerUrl + '/api/track',
                          JSON.stringify(exitData)
                      );
                  }
              } catch (e) {
                  console.error('Error tracking exit:', e);
              }
          }

          // Execute tracking when DOM is loaded
          if (document.readyState === 'loading') {
              document.addEventListener('DOMContentLoaded', trackPageView);
          } else {
              trackPageView();
          }

          // Set up exit tracking
          window.addEventListener('beforeunload', trackExit);
      })();
    </script>
  </head>
  <body style="background-image: url('bg_img.png');">
    <ul class="topnav">
      <li><a class="active" href="#home">Home</a></li>
      <li><a href="rating.html">Ratings</a></li>
      <li><a href="resume.html">Create Resume</a></li>
      <li><a href="dashboard">Analytics</a></li>
    </ul>

    <section class="column">
      <a href="masud.html">
        <img src="KMC.png" width="500px" height="500px">
      </a>
      <div id="faraz">
      </div>
    </section> 

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.3/dist/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
  </body>
</html>
